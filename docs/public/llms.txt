# dotagents

> A package manager for .agents directories

dotagents manages agent skill dependencies declared in `agents.toml`, maintains a lockfile (`agents.lock`) for reproducibility, and handles symlinks so tools like Claude Code, Cursor, Codex, VS Code, and OpenCode discover skills from a single canonical location (`.agents/skills/`).

Install: `npm install -g @sentry/dotagents`
Run without installing: `npx @sentry/dotagents <command>`

## Quick Start

```bash
# Initialize a project (interactive TUI)
npx @sentry/dotagents init

# Add a single skill from GitHub
npx @sentry/dotagents add getsentry/skills --name find-bugs

# Add all skills from a repo
npx @sentry/dotagents add getsentry/skills --all

# Install all declared skills
npx @sentry/dotagents install
```

This creates an `agents.toml`:

```toml
version = 1
gitignore = false
agents = ["claude"]

[[skills]]
name = "find-bugs"
source = "getsentry/skills"
```

And a lockfile (`agents.lock`) pinning the exact commit and SHA-256 integrity hash.

## How It Works

1. Declare skill dependencies in `agents.toml` at the project root (or `~/.agents/agents.toml` for user scope)
2. `install` clones repos, discovers skills by convention, and copies them into `.agents/skills/`
3. `agents.lock` records the resolved commit and a SHA-256 integrity hash for each skill
4. Symlinks connect `.agents/skills/` to each agent's expected location (`.claude/skills/`, `.cursor/skills/`, etc.)
5. MCP and hook configs are generated for each declared agent
6. By default (`gitignore = false`), skills are checked into git. Set `gitignore = true` to exclude managed skills via `.agents/.gitignore`.

## Configuration (agents.toml)

Full example with all sections:

```toml
version = 1
gitignore = false
agents = ["claude", "cursor"]

[project]
name = "my-project"

# Trust policy (optional -- restricts allowed sources)
[trust]
github_orgs = ["getsentry"]
github_repos = ["external-org/specific-repo"]
git_domains = ["git.corp.example.com"]

# Individual skill
[[skills]]
name = "find-bugs"
source = "getsentry/skills"

# Pinned to a ref
[[skills]]
name = "review"
source = "getsentry/skills@v1.0.0"

# Non-GitHub git
[[skills]]
name = "internal"
source = "git:https://git.corp.dev/repo"

# Local directory
[[skills]]
name = "local"
source = "path:./my-skills/local-skill"

# Wildcard: all skills from a repo
[[skills]]
name = "*"
source = "getsentry/skills"
exclude = ["deprecated-skill"]

# Stdio MCP server
[[mcp]]
name = "github"
command = "npx"
args = ["-y", "@modelcontextprotocol/server-github"]
env = ["GITHUB_TOKEN"]

# HTTP MCP server (OAuth)
[[mcp]]
name = "remote-api"
url = "https://mcp.example.com/sse"

# Hooks
[[hooks]]
event = "PreToolUse"
matcher = "Bash"
command = "my-lint-check"

[[hooks]]
event = "Stop"
command = "notify-done"
```

### Top-level Fields

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `version` | integer | Yes | -- | Schema version. Always `1`. |
| `gitignore` | boolean | No | `true` | When `true`, generates `.agents/.gitignore` to exclude managed skills. When `false`, skills are checked into git. `init` sets this to `false`. |
| `agents` | string[] | No | `[]` | Agent tool IDs: `claude`, `cursor`, `codex`, `vscode`, `opencode`. Creates symlinks and config files for each. |

### Skills

Each `[[skills]]` entry requires `name` and `source`. Optional fields: `ref` (git ref), `path` (subdirectory override).

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Skill name. Pattern: `^[a-zA-Z0-9][a-zA-Z0-9._-]*$`. Use `"*"` for wildcard. |
| `source` | string | Yes | `owner/repo`, `owner/repo@ref`, `git:<url>`, or `path:<relative>` |
| `ref` | string | No | Git ref (tag, branch, or SHA). Also supported inline: `owner/repo@ref`. |
| `path` | string | No | Subdirectory within repo. Only needed when auto-discovery fails. |

Source formats:
- `owner/repo` -- GitHub (auto-discovers skills by name)
- `owner/repo@ref` -- GitHub pinned to a tag/branch/commit
- `git:<url>` -- Non-GitHub git (requires https://, git://, ssh://, git@, file://, or absolute path)
- `path:<relative>` -- Local filesystem path (relative to project root)

### Wildcard Skills

Set `name = "*"` to install all skills from a source. Use `exclude` to skip specific skills.

```toml
[[skills]]
name = "*"
source = "getsentry/skills"
exclude = ["deprecated-skill"]
```

Wildcards are expanded during `install` and `update`. Each discovered skill gets its own lockfile entry.

### MCP Servers

Each `[[mcp]]` entry requires `name` and either `command` (stdio) or `url` (HTTP), not both.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Unique server identifier |
| `command` | string | Stdio only | Command to execute |
| `args` | string[] | No | Command arguments |
| `url` | string | HTTP only | Server URL |
| `headers` | table | No | HTTP headers (url servers only) |
| `env` | string[] | No | Environment variable names to pass through |

Config files generated per agent:
- Claude: `.mcp.json` (JSON)
- Cursor: `.cursor/mcp.json` (JSON)
- Codex: `.codex/config.toml` (TOML, shared with other Codex config)
- VS Code: `.vscode/mcp.json` (JSON)
- OpenCode: `opencode.json` (JSON, shared)

### Hooks

Each `[[hooks]]` entry requires `event` and `command`. Optional: `matcher` to filter by tool name.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `event` | string | Yes | `PreToolUse`, `PostToolUse`, `UserPromptSubmit`, `Stop` |
| `matcher` | string | No | Tool name filter (e.g. `Bash`, `Write`) |
| `command` | string | Yes | Shell command to run |

Hook config files per agent:
- Claude: `.claude/settings.json` (merged into existing file)
- Cursor: `.cursor/hooks.json` (dedicated file, events mapped to Cursor equivalents)
- VS Code: `.claude/settings.json` (same file as Claude)
- Codex/OpenCode: not supported

Cursor event mapping:
- `PreToolUse` -> `beforeShellExecution` + `beforeMCPExecution`
- `PostToolUse` -> `afterFileEdit`
- `UserPromptSubmit` -> `beforeSubmitPrompt`
- `Stop` -> `stop`

### Trust

Optional `[trust]` section to restrict allowed skill sources.

| Field | Type | Description |
|-------|------|-------------|
| `allow_all` | boolean | Allow all sources (overrides other fields) |
| `github_orgs` | string[] | Allowed GitHub org/user names |
| `github_repos` | string[] | Allowed exact `owner/repo` pairs |
| `git_domains` | string[] | Allowed domains for `git:` URLs |

Rules:
- No `[trust]` section = all sources allowed (backward compatible)
- `allow_all = true` = all sources allowed (explicit intent)
- `[trust]` present without `allow_all` = allowlist mode (source must match at least one rule)
- Local `path:` sources are always allowed
- Trust is validated before any network operations in `add` and `install`

## CLI Commands

Global flags (before command name):
- `--user` -- Operate on user scope (`~/.agents/`) instead of the current project
- `--help`, `-h` -- Show help
- `--version`, `-V` -- Show version

### init

```
dotagents init [--force] [--agents claude,cursor]
```

Create `agents.toml` and `.agents/skills/` directory. Interactive mode (when TTY is available) prompts for agent targets, gitignore preference, and trust policy.

| Flag | Description |
|------|-------------|
| `--agents <list>` | Comma-separated agent targets |
| `--force` | Overwrite existing `agents.toml` |

### install

```
dotagents install [--frozen] [--force]
```

Install all dependencies from `agents.toml`. Resolves sources, copies skills, writes lockfile, creates symlinks, generates MCP and hook configs.

| Flag | Description |
|------|-------------|
| `--frozen` | Fail if lockfile is missing or stale; do not write lockfile. For CI. |
| `--force` | Re-resolve and re-install all skills, ignoring cache and locked commits |

### add

```
dotagents add <source> [--name <name>] [--ref <ref>] [--all]
```

Add a skill dependency and install it. Auto-discovers skills in the repo.

| Flag | Description |
|------|-------------|
| `--name <name>` | Specify which skill to add (alias: `--skill`) |
| `--ref <ref>` | Pin to a specific tag, branch, or commit |
| `--all` | Add all skills from the source as a wildcard entry (`name = "*"`) |

When a repo has one skill, it is added automatically. When multiple skills are found without `--name` or `--all`, they are listed with instructions to pick one.

### remove

```
dotagents remove <name>
```

Remove a skill from `agents.toml`, delete from disk, and update the lockfile. For skills sourced from a wildcard entry, prompts to add the skill to the `exclude` list instead of removing the entire wildcard.

### update

```
dotagents update [name]
```

Update all or one skill to latest version. Skips skills pinned to immutable refs (40-char SHAs). For wildcard entries, re-discovers all skills in the source, adds new ones, and removes deleted ones. Prints a changelog with old and new commits.

### sync

```
dotagents sync
```

Reconcile project state: adopt orphaned skills (installed but not declared), regenerate `.agents/.gitignore`, check for missing skills, verify integrity hashes, repair symlinks, verify/repair MCP and hook configs. Reports issues as warnings or errors.

### list

```
dotagents list [--json]
```

Show installed skills and status.

| Status | Meaning |
|--------|---------|
| `✓` | Installed, integrity matches lockfile |
| `~` | Modified locally since install |
| `✗` | In config but not installed |
| `?` | Installed but not in lockfile |

Skills from wildcard entries are marked with a wildcard indicator.

## Agent Targets

| ID | Tool | Config Dir | Skills Symlink | MCP Config | Hooks |
|----|------|-----------|----------------|------------|-------|
| `claude` | Claude Code | `.claude` | `.claude/skills/` -> `.agents/skills/` | `.mcp.json` | `.claude/settings.json` |
| `cursor` | Cursor | `.cursor` | `.cursor/skills/` -> `.agents/skills/` | `.cursor/mcp.json` | `.cursor/hooks.json` |
| `codex` | Codex | `.codex` | (reads `.agents/skills/` natively) | `.codex/config.toml` | Not supported |
| `vscode` | VS Code Copilot | `.vscode` | (reads `.agents/skills/` natively) | `.vscode/mcp.json` | `.claude/settings.json` |
| `opencode` | OpenCode | `.claude` | (reads `.agents/skills/` natively) | `opencode.json` | Not supported |

Claude and Cursor use symlinks from their config directory to `.agents/skills/`. Codex, VS Code, and OpenCode read `.agents/skills/` directly.

## Scopes

### Project Scope (default)

Operates on the current project directory. Requires `agents.toml` at the project root.

- Config: `<project>/agents.toml`
- Skills: `<project>/.agents/skills/`
- Lockfile: `<project>/agents.lock`

### User Scope (`--user`)

Operates on the user's home directory. For skills shared across all projects.

- Config: `~/.agents/agents.toml`
- Skills: `~/.agents/skills/`
- Lockfile: `~/.agents/agents.lock`
- Override location: `DOTAGENTS_HOME` environment variable

User-scope symlinks: `~/.claude/skills/` and `~/.cursor/skills/`.

When no `agents.toml` exists and you are not inside a git repo, dotagents falls back to user scope automatically.

## Skill Discovery

After cloning a repo, dotagents scans these locations for skills:

1. `<name>/SKILL.md` (root-level directory)
2. `skills/<name>/SKILL.md`
3. `.agents/skills/<name>/SKILL.md`
4. `.claude/skills/<name>/SKILL.md`
5. `plugins/*/skills/<name>/SKILL.md` (marketplace format, requires `.claude-plugin/` marker)

Use the `path` field for explicit overrides when auto-discovery does not find the skill.

A valid skill directory contains a `SKILL.md` file with YAML frontmatter:

```markdown
---
name: my-skill
description: What this skill does
---

# Skill instructions here
```

Required frontmatter fields: `name` (string), `description` (string).

## Lockfile (agents.lock)

Auto-generated TOML file. Do not edit manually. Commit to version control.

```toml
# Auto-generated by dotagents. Do not edit.
version = 1

[skills.find-bugs]
source = "getsentry/skills"
resolved_url = "https://github.com/getsentry/skills.git"
resolved_path = "plugins/sentry-skills/skills/find-bugs"
commit = "c8881564e75eff4faaecc82d1c3f13356851b6e7"
integrity = "sha256-FWmCLdOj+x+XffiEg7Bx19drylVypeKz8me9OA757js="
```

| Field | Present For | Description |
|-------|-------------|-------------|
| `source` | All | Original source from `agents.toml` |
| `resolved_url` | Git sources | Resolved git clone URL |
| `resolved_path` | Git sources | Subdirectory within repo where skill was found |
| `resolved_ref` | Git sources (optional) | Resolved ref name (omitted for default branch) |
| `commit` | Git sources | Full 40-char SHA |
| `integrity` | All | `sha256-` prefixed base64 content hash |

Local `path:` skills have `source` and `integrity` only.

### Integrity Algorithm

1. Walk all files in the skill directory, sorted alphabetically by relative path
2. SHA-256 hash each file's contents
3. Concatenate `<relative-path>\0<hex-hash>\n` for each file
4. SHA-256 hash the concatenation
5. Base64-encode and prefix with `sha256-`

### Frozen Mode

`dotagents install --frozen` (for CI):
- Fails if `agents.lock` does not exist
- Fails if any skill in `agents.toml` is missing from the lockfile
- Fails if integrity hashes don't match after install
- Does not modify the lockfile

## Caching

Location: `~/.local/dotagents/` (override: `DOTAGENTS_STATE_DIR`)

- Unpinned repos (`owner/repo/`): shallow clone, refreshed after 24-hour TTL
- Pinned refs (`owner/repo@sha/`): immutable, never re-fetched
- All git operations are non-interactive (`GIT_TERMINAL_PROMPT=0`)
- Use `dotagents install --force` to bypass cache

## Environment Variables

| Variable | Description |
|----------|-------------|
| `DOTAGENTS_STATE_DIR` | Override cache location (default: `~/.local/dotagents`) |
| `DOTAGENTS_HOME` | Override user-scope location (default: `~/.agents`) |

## Gitignore Strategy

- `gitignore = false` (set by `init`): Skills are checked into git. No `.agents/.gitignore` is created. Anyone cloning the repo gets skills without running `install`.
- `gitignore = true` (schema default when field is absent): Generates `.agents/.gitignore` listing managed skills. Custom skills in `.agents/skills/` are not gitignored.
- `.agents/.gitignore` is regenerated on every `install`, `add`, `remove`, and `sync`.

## Links

- Source: https://github.com/getsentry/dotagents
- npm: https://www.npmjs.com/package/@sentry/dotagents
